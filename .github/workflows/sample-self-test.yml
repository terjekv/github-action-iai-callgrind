name: Sample Fixture Self-Test

on:
  pull_request:
    paths:
      - ".github/workflows/iai-callgrind-pr-bench.yml"
      - ".github/workflows/sample-self-test.yml"
      - "scripts/**"
      - "examples/sample-rust-app/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  clippy-sample:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run clippy on sample fixture
        run: cargo clippy --all-targets --all-features -- -D warnings
        working-directory: examples/sample-rust-app

  bench-sample:
    needs: clippy-sample
    uses: ./.github/workflows/iai-callgrind-pr-bench.yml
    with:
      working_directory: examples/sample-rust-app
      benchmarks_json: '["sample_bench"]'
      feature_sets_json: '[{"name":"default","features":""},{"name":"alt-impl","features":"alt-impl"}]'
      regression_threshold_pct: 2
      fail_on_regression: false
      comment_mode: always
